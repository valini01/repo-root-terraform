name: "ğŸ”„ Deploy Staging Branch (NLV Environment)"

on:
  pull_request:
    branches:
      - staging
    types: [closed]  # Only when PR is merged

jobs:
  # ğŸš¦ STEP 1: Validate for NLV environment
  terraform-validate:
    name: "âœ… Terraform Validate (NLV)"
    if: github.event.pull_request.merged == true
    uses: ./.github/templates/terraform-validate.yml@main
    with:
      environment: nlv
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸ“‹ STEP 2: Plan for NLV environment
  terraform-plan:
    name: "ğŸ“‹ Terraform Plan (NLV)"
    needs: terraform-validate
    uses: ./.github/templates/terraform-plan.yml@main
    with:
      environment: nlv
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸ”’ STEP 3: Apply with APPROVAL GATE
  terraform-apply:
    name: "ğŸš€ Terraform Apply (NLV) - Requires Approval ğŸ”’"
    needs: terraform-plan
    if: github.event.pull_request.merged == true
    uses: ./.github/templates/terraform-apply.yml@main
    with:
      environment: nlv
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸ¤– STEP 4: Auto-create PR to main (production)
  create-main-pr:
    name: "ğŸ¤– Auto-Create PR to Main (Production)"
    needs: terraform-apply
    if: success() && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Get source branch from merge commit
      id: get-source
      run: |
        # Try to extract the original feature branch name from merge commit
        SOURCE_BRANCH=$(git log --merges --oneline -1 --pretty=format:"%s" | grep -o 'feature/[^[:space:]]*' | head -1 || echo "unknown")
        echo "source_branch=${SOURCE_BRANCH}" >> $GITHUB_OUTPUT
        echo "Found source branch: ${SOURCE_BRANCH}"
    
    - name: Check and Create Main Branch
      run: |
        TARGET_BRANCH="main"
        TARGET_BRANCH=${TARGET_BRANCH:-main}
        echo "Using target branch: $TARGET_BRANCH"
        
        # Set environment variable for consistent usage
        export TARGET_BRANCH="$TARGET_BRANCH"
        echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_ENV
        
        # Check if main branch exists (it should, but let's be safe)
        if git ls-remote --heads origin $TARGET_BRANCH | grep -q $TARGET_BRANCH; then
          echo "âœ… Branch '$TARGET_BRANCH' already exists"
        else
          echo "ğŸŒ¿ Creating branch '$TARGET_BRANCH'"
          git checkout -b $TARGET_BRANCH
          git push origin $TARGET_BRANCH
          echo "âœ… Branch '$TARGET_BRANCH' created successfully"
        fi
    
    - name: Create Pull Request to Main
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        base: ${{ env.TARGET_BRANCH }}  # ğŸ¯ Target: main branch (dynamic)
        head: staging  # ğŸŒ¿ Source: staging branch
        title: "ğŸ­ Auto PR: Deploy to Production (${{ env.TARGET_BRANCH }})"
        body: |
          ## ğŸ­ Production Deployment PR
          
          **Source Flow:** `${{ steps.get-source.outputs.source_branch }}` â†’ `staging` â†’ `main`
          **Target Environment:** Live (LV) - **PRODUCTION** ğŸš¨
          
          ### âœ… Deployment History
          - [x] LAB deployment successful âœ…
          - [x] NLV deployment successful âœ…  
          - [x] All approval gates passed âœ…
          - [ ] Ready for PRODUCTION deployment â³
          
          ### ğŸ”’ Production Safety Checks
          - [x] Code reviewed in feature branch âœ…
          - [x] LAB environment tested âœ…
          - [x] NLV environment verified âœ…
          - [x] Team lead approval obtained âœ…
          - [ ] **PRODUCTION APPROVAL REQUIRED** ğŸš¨
          
          ### ğŸ—ï¸ Infrastructure Changes
          - Resource Group: `rg-non-live-demo` â†’ `rg-live-demo`
          - Storage Account: `nonlivesa003` â†’ `livesa002`
          - Key Vault: `nonlive-kv-testing` â†’ `live-kv-testing`
          
          ### âš ï¸ Production Deployment Notes
          - **Multiple approvals required** for production
          - **Extended approval gate** with waiting period
          - **Full audit trail** maintained
          - **Rollback plan** available if needed
          
          **ğŸ¤– Auto-generated PR from successful NLV deployment**
          
          **Original feature:** `${{ steps.get-source.outputs.source_branch }}`
          **Commit SHA:** `${{ github.sha }}`
          **Deployed by:** @${{ github.actor }}
        draft: false

  # ğŸ—‘ï¸ STEP 5: Clean up - Delete the source feature branch
  delete-feature-branch:
    name: "ğŸ—‘ï¸ Delete Feature Branch"
    needs: create-main-pr
    if: success()
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Get and delete source feature branch
      run: |
        # Extract the original feature branch name
        SOURCE_BRANCH=$(git log --merges --oneline -1 --pretty=format:"%s" | grep -o 'feature/[^[:space:]]*' | head -1 || echo "")
        
        if [[ ! -z "$SOURCE_BRANCH" && "$SOURCE_BRANCH" != "unknown" ]]; then
          echo "ğŸ—‘ï¸ Deleting feature branch: $SOURCE_BRANCH"
          git push origin --delete $SOURCE_BRANCH || echo "âš ï¸ Branch already deleted or doesn't exist"
          echo "âœ… Feature branch $SOURCE_BRANCH has been deleted"
        else
          echo "âš ï¸ Could not determine source feature branch name"
        fi

  # ğŸ’¥ MANUAL STEP: Destroy infrastructure
  terraform-destroy:
    name: "ğŸ’¥ Terraform Destroy (NLV) - Manual Only"
    if: github.event_name == 'workflow_dispatch'
    uses: ./.github/templates/terraform-destroy.yml@main
    with:
      environment: nlv
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}