name: "üîÑ Deploy Staging (NLV Environment)"

on:
  pull_request:
    types: [closed]
    branches:
      - staging

jobs:
  validate:
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/terraform-validate.yml
    with:
      environment: nlv
    secrets: inherit

  plan:
    if: github.event.pull_request.merged == true
    needs: validate
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: nlv
    secrets: inherit

  apply:
    if: github.event.pull_request.merged == true
    needs: plan
    uses: ./.github/workflows/terraform-apply.yml
    with:
      environment: nlv
    secrets: inherit

  destroy:
    needs: apply
    uses: ./.github/workflows/terraform-destroy.yml
    with:
      environment: nlv
    secrets: inherit    

  create-main-pr:
    if: github.event.pull_request.merged == true
    needs: apply
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - name: Set GH_TOKEN
        run: |
          echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> $GITHUB_ENV
          echo "‚úÖ Authenticated with GitHub App successfully"

      - name: Create Pull Request to Main
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head staging --json number --jq '.[0].number')

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --base main \
              --head staging \
              --title "üöÄ Deploy NLV to Production (LV)" \
              --body "### üéØ Staging to Production Promotion

          **Source Environment:** NLV (Staging)
          **Target Environment:** LV (Production)
          **Triggered by:** Merge of PR #${{ github.event.pull_request.number }}
          
          ‚úÖ NLV deployment completed successfully
          ‚úÖ All quality scans passed
          
          ### üìã Deployment Checklist
          - [ ] NLV environment validated
          - [ ] Stakeholder approval obtained
          - [ ] Production deployment window confirmed
          
          **‚ö†Ô∏è This will deploy to PRODUCTION. Ensure all validations are complete.**"
            echo "‚úÖ Created PR from staging to main"
          else
            echo "‚ÑπÔ∏è PR #$EXISTING_PR already exists from staging to main"
          fi
