name: Terraform Format Check

on:
  workflow_call:
    inputs:
      workingDirectory:
        description: "Working Directory"
        required: false
        default: "."
        type: string
    secrets:
      GH_PAT:
        required: false

jobs:
  tf_fmt_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git for Private Modules
        run: git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '>= 1.9, < 2.0.0'  # Use a version range

      # - name: Initialize Terraform
      #   run: terraform init
      #   working-directory: ${{ inputs.workingDirectory }}


      # ðŸŸ© UPDATED Terraform Init with backend config
      - name: Initialize Terraform Backend
        run: |
          echo "ðŸ”§ Initializing Terraform backend..."
          terraform init \
            -backend-config="resource_group_name=${{ vars.STATE_RESOURCE_GROUP_NAME }}" \
            -backend-config="storage_account_name=${{ vars.STATE_STORAGE_ACCOUNT_NAME }}" \
            -backend-config="container_name=${{ vars.STATE_CONTAINER_NAME }}" \
            -backend-config="key=${{ inputs.environment }}.tfstate"
        working-directory: ${{ inputs.workingDirectory }}

      - name: Validate Terraform Code
        run: terraform validate
        working-directory: ${{ inputs.workingDirectory }}

      - name: Run Terraform Format Check
        run: terraform fmt -list=true -write=false -diff=true -check=true -recursive
        working-directory: ${{ inputs.workingDirectory }}
