name: Terraform Format Check

on:
  workflow_call:
    inputs:
      workingDirectory:
        description: "Working Directory"
        required: false
        default: "."
        type: string
    secrets:
      GH_PAT:
        required: false

jobs:
  tf_fmt_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git for Private Modules
        run: |
          if [ -n "${{ secrets.GH_PAT }}" ]; then
            git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"
            echo "✅ Git authentication configured"
          else
            echo "⚠️ GH_PAT not provided, skipping Git authentication"
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '>= 1.9, < 2.0.0'

      - name: Initialize Terraform
        run: terraform init -backend=false
        working-directory: ${{ inputs.workingDirectory }}

      - name: Validate Terraform Code
        run: terraform validate
        working-directory: ${{ inputs.workingDirectory }}

      - name: Run Terraform Format Check
        run: terraform fmt -list=true -write=false -diff=true -check=true -recursive
        working-directory: ${{ inputs.workingDirectory }}