name: "üéõÔ∏è Combined Multi-Environment Pipeline"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select target environment'
        required: true
        default: 'lab'
        type: choice
        options:
        - lab
        - nlv
        - lv
      action:
        description: 'Select action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
        - validate
        - plan
        - apply
        - destroy
      reason:
        description: 'Reason for manual deployment'
        required: true
        type: string

env:
  SELECTED_ENVIRONMENT: ${{ github.event.inputs.environment }}
  SELECTED_ACTION: ${{ github.event.inputs.action }}

jobs:
  # üö¶ STEP 1: Always validate first (unless destroying)
  terraform-validate:
    name: "‚úÖ Terraform Validate (${{ github.event.inputs.environment }})"
    if: inputs.action == 'validate' || inputs.action == 'plan' || inputs.action == 'apply'
    uses: ./.github/templates/terraform-validate.yml
    with:
      environment: ${{ github.event.inputs.environment }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # üìã STEP 2: Plan the deployment
  terraform-plan:
    name: "üìã Terraform Plan (${{ github.event.inputs.environment }})"
    if: inputs.action == 'plan' || inputs.action == 'apply'
    needs: terraform-validate
    uses: ./.github/templates/terraform-plan.yml
    with:
      environment: ${{ github.event.inputs.environment }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # üöÄ STEP 3: Apply the deployment (with approval gates)
  terraform-apply:
    name: "üöÄ Terraform Apply (${{ github.event.inputs.environment }}) - Manual"
    if: inputs.action == 'apply'
    needs: terraform-plan
    uses: ./.github/templates/terraform-apply.yml
    with:
      environment: ${{ github.event.inputs.environment }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # üí• STEP 4: Destroy infrastructure (with approval gates)
  terraform-destroy:
    name: "üí• Terraform Destroy (${{ github.event.inputs.environment }}) - Manual"
    if: inputs.action == 'destroy'
    uses: ./.github/templates/terraform-destroy.yml
    with:
      environment: ${{ github.event.inputs.environment }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # üìä STEP 5: Log manual deployment
  log-manual-deployment:
    name: "üìä Log Manual Deployment"
    if: always() && (needs.terraform-apply.result == 'success' || needs.terraform-destroy.result == 'success')
    needs: [terraform-apply, terraform-destroy]
    runs-on: ubuntu-latest
    
    steps:
    - name: Create manual deployment log
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ needs.terraform-apply.result }}' === 'success' ? 'Applied' : 
                        '${{ needs.terraform-destroy.result }}' === 'success' ? 'Destroyed' : 'Unknown';
          
          const logEntry = `## üìä Manual Deployment Log
          
          **Action:** ${status}
          **Environment:** ${{ github.event.inputs.environment }}
          **Performed by:** @${{ github.actor }}
          **Reason:** ${{ github.event.inputs.reason }}
          **Timestamp:** ${new Date().toISOString()}
          **Workflow Run:** ${{ github.run_id }}
          
          ### Details
          - **Repository:** ${{ github.repository }}
          - **Branch:** ${{ github.ref_name }}
          - **Commit:** ${{ github.sha }}
          - **Action:** ${{ github.event.inputs.action }}
          - **Environment:** ${{ github.event.inputs.environment }}
          
          **Manual deployment completed via Combined Pipeline.**
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `üìä Manual ${status} - ${{ github.event.inputs.environment }} - ${new Date().toISOString().split('T')[0]}`,
            body: logEntry,
            labels: ['manual-deployment', '${{ github.event.inputs.environment }}', '${{ github.event.inputs.action }}']
          });