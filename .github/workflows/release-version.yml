name: "Auto Release Version (after main updated)"

on:
  push:
    branches:
      - main   # Trigger only AFTER main receives new commit from merged PR

permissions:
  contents: write
  packages: write

jobs:
  release-version:
    runs-on: ubuntu-latest
    name: "Create New Version Tag"

    env:
      REPO: ${{ github.repository }}
      GITHUB_API: https://api.github.com

    steps:
      - name: Checkout repo with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      #############################################################
      # 1️⃣ Detect the feature branch that was merged into main
      #############################################################

      - name: Detect merged feature branch from commit message
        id: detect_branch
        run: |
          BRANCH=$(git log -1 --pretty=%B | sed -n 's/Merge pull request #[0-9]* from .*\/\(.*\)/\1/p')
          echo "HEAD_BRANCH=$BRANCH" >> $GITHUB_ENV

          if [ -z "$BRANCH" ]; then
            echo "❌ Could not detect a merged branch. Exiting."
            exit 1
          fi

          echo "Merged branch detected: $BRANCH"

      #############################################################
      # 2️⃣ Authenticate GitHub App (installation access token)
      #############################################################

      - name: Generate GitHub App Token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}
          installation_retrieval_mode: repository
          installation_retrieval_payload: ${{ github.repository }}
          revoke: true

      - name: Set GH_TOKEN
        run: |
          echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> $GITHUB_ENV
          echo "✅ Authenticated with GitHub App successfully"

      #############################################################
      # 3️⃣ Ensure merged feature branch was deleted
      #############################################################

      - name: Verify merged branch was deleted
        env:
          HEAD_BRANCH: ${{ env.HEAD_BRANCH }}
          GH_TOKEN: ${{ env.GH_TOKEN }}
        run: |
          echo "Checking deletion status of '$HEAD_BRANCH'..."

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "${GITHUB_API}/repos/${REPO}/branches/${HEAD_BRANCH}")

          if [ "$STATUS" = "404" ]; then
            echo "✅ Branch '$HEAD_BRANCH' is deleted."
          else
            echo "❌ Branch '$HEAD_BRANCH' still exists (HTTP $STATUS). Release aborted."
            exit 1
          fi

      #############################################################
      # 4️⃣ Calculate new version
      #############################################################

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compute next version
        id: compute_version
        run: |
          CURRENT=$(jq -r '.module_version' version.json)
          STRIPPED=$(echo "$CURRENT" | sed 's/^v//')

          NEW=$(echo "$STRIPPED" | awk -F. -v OFS=. '{$NF += 1 ; print}')
          NEW_TAG="v${NEW}"

          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

          echo "Next version: $NEW_TAG"

      #############################################################
      # 5️⃣ Create and push tag
      #############################################################

      - name: Create annotated git tag
        env:
          NEW_TAG: ${{ env.NEW_TAG }}
          GH_TOKEN: ${{ env.GH_TOKEN }}
        run: |
          git config user.email "github-app@automation"
          git config user.name "GitHub Automation"

          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${REPO}" "$NEW_TAG"

      #############################################################
      # 6️⃣ Update version.json in main
      #############################################################

      - name: Update version.json
        env:
          NEW_TAG: ${{ env.NEW_TAG }}
          GH_TOKEN: ${{ env.GH_TOKEN }}
        run: |
          jq -n --arg v "$NEW_TAG" '{"module_version":$v}' > version.json

          git add version.json
          if git commit -m "chore: bump version to $NEW_TAG"; then
            git push "https://x-access-token:${GH_TOKEN}@github.com/${REPO}" main
            echo "version.json updated."
          else
            echo "No changes to commit."
          fi
