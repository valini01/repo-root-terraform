name: "üè≠ Deploy Production (Live LV)"

on:
  workflow_dispatch:

jobs:
  validate:
    uses: ./.github/workflows/terraform-validate.yml
    with:
      environment: lv
    secrets: inherit

  plan:
    needs: validate
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: lv
    secrets: inherit

  apply:
    needs: plan
    uses: ./.github/workflows/terraform-apply.yml
    with:
      environment: lv
    secrets: inherit


    cleanup-feature-branch:
    name: "üßπ Delete Deployed Feature Branch"
    needs: apply
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Identify merged feature branch
        id: find_branch
        run: |
          # Find the last merged feature branch from commit history
          FEATURE_BRANCH=$(git log --merges --oneline -n 5 | grep -o 'feature/[^[:space:]]*' | head -1 || echo "")
          echo "feature_branch=$FEATURE_BRANCH" >> $GITHUB_OUTPUT
          echo "üîç Found merged branch: $FEATURE_BRANCH"

      - name: Delete remote feature branch
        if: steps.find_branch.outputs.feature_branch != ''
        run: |
          BRANCH=${{ steps.find_branch.outputs.feature_branch }}
          echo "üßπ Deleting remote branch: $BRANCH"
          git push origin --delete $BRANCH || echo "‚ö†Ô∏è Could not delete $BRANCH"
          echo "‚úÖ Cleanup complete ‚Äî staging and main remain."