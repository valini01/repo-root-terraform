name: "üè≠ Deploy Production (Live LV)"

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/terraform-validate.yml
    with:
      environment: live
    secrets: inherit

  plan:
    needs: validate
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: live
    secrets: inherit

  apply:
    needs: plan
    uses: ./.github/workflows/terraform-apply.yml
    with:
      environment: live
    secrets: inherit

  destroy:
    needs: apply
    uses: ./.github/workflows/terraform-destroy.yml
    with:
      environment: live
    secrets: inherit

  cleanup-feature-branch:
    name: "üßπ Delete Deployed Feature Branch"
    needs: destroy
    if: success() && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Identify and delete merged feature branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the branch from the most recent merged PR to staging
          echo "üîç Looking for feature branch that was merged to staging..."
          FEATURE_BRANCH=$(gh pr list --repo ${{ github.repository }} --state merged --base staging --limit 1 --json headRefName --jq '.[0].headRefName' || echo "")
          
          if [ -z "$FEATURE_BRANCH" ]; then
            echo "‚ö†Ô∏è No feature branch found in recent staging merges"
            exit 0
          fi
          
          echo "üîç Found feature branch: $FEATURE_BRANCH"
          echo "üßπ Deleting remote branch: $FEATURE_BRANCH"
          
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/heads/$FEATURE_BRANCH" || echo "‚ö†Ô∏è Could not delete $FEATURE_BRANCH (may already be deleted)"
          
          echo "‚úÖ Cleanup complete ‚Äî staging and main remain."
