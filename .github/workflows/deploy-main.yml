name: "ğŸ­ Deploy Main Branch (LV Production Environment)"

on:
  pull_request:
    branches:
      - main
    types: [closed]  # Only when PR is merged

jobs:
  # ğŸš¦ STEP 1: Validate for Production environment
  terraform-validate:
    name: "âœ… Terraform Validate (PRODUCTION)"
    uses: ./.github/templates/terraform-validate.yml
    with:
      environment: lv
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸ“‹ STEP 2: Plan for Production environment
  terraform-plan:
    name: "ğŸ“‹ Terraform Plan (LV)"
    needs: terraform-validate
    uses: ./.github/templates/terraform-plan.yml@main
    with:
      environment: lv
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸ”’ğŸ”’ STEP 3: Apply with MULTIPLE APPROVAL GATES
  terraform-apply:
    name: "ğŸ­ Terraform Apply (PRODUCTION) - MULTIPLE APPROVALS REQUIRED ğŸ”’ğŸ”’"
    needs: terraform-plan
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/templates/terraform-apply.yml
    with:
      environment: lv
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸ‰ STEP 4: Production deployment complete notification
  production-deployment-complete:
    name: "ğŸ‰ Production Deployment Complete"
    needs: terraform-apply
    if: success()
    runs-on: ubuntu-latest
    
    steps:
    - name: Get deployment details
      id: details
      run: |
        echo "timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        echo "environment=Live (LV) - Production" >> $GITHUB_OUTPUT
    
    - name: Notify deployment success
      run: |
        echo "ğŸ‰ğŸ‰ğŸ‰ PRODUCTION DEPLOYMENT COMPLETED SUCCESSFULLY! ğŸ‰ğŸ‰ğŸ‰"
        echo ""
        echo "ğŸ“Š Deployment Summary:"
        echo "  ğŸ­ Environment: ${{ steps.details.outputs.environment }}"
        echo "  ğŸŒ¿ Branch: main"
        echo "  ğŸ“ Commit: ${{ github.sha }}"
        echo "  ğŸ‘¤ Deployed by: ${{ github.actor }}"
        echo "  â° Completed at: ${{ steps.details.outputs.timestamp }}"
        echo ""
        echo "ğŸ—ï¸ Infrastructure Resources:"
        echo "  ğŸ“¦ Resource Group: rg-live-demo"
        echo "  ğŸ’¾ Storage Account: livesa002"
        echo "  ğŸ” Key Vault: live-kv-testing"
        echo ""
        echo "âœ… All systems are live in production!"
    
    - name: Create deployment success issue
      uses: actions/github-script@v7
      with:
        script: |
          const deploymentSummary = `## ğŸ‰ Production Deployment Successful
          
          **Environment:** Live (LV) - Production  
          **Branch:** main  
          **Commit:** ${{ github.sha }}  
          **Deployed by:** @${{ github.actor }}  
          **Completed:** ${{ steps.details.outputs.timestamp }}
          
          ### ğŸ—ï¸ Infrastructure Deployed
          - **Resource Group:** \`rg-live-demo\`
          - **Storage Account:** \`livesa002\`
          - **Key Vault:** \`live-kv-testing\`
          
          ### âœ… Deployment Journey
          1. [x] Feature development and LAB testing
          2. [x] Staging deployment and validation
          3. [x] Production approval and deployment
          4. [x] **PRODUCTION LIVE** ğŸš€
          
          All systems operational in production environment.
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ‰ Production Deployment Complete - ${new Date().toISOString().split('T')[0]}`,
            body: deploymentSummary,
            labels: ['deployment', 'production', 'success']
          });

  # ğŸ“Š STEP 5: Generate deployment report
  generate-deployment-report:
    name: "ğŸ“Š Generate Deployment Report"
    needs: production-deployment-complete
    if: success()
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate deployment report
      run: |
        cat << EOF > deployment-report.md
        # ğŸ“Š Production Deployment Report
        
        **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        **Environment:** Live (LV) - Production
        **Repository:** ${{ github.repository }}
        **Branch:** main
        **Commit SHA:** ${{ github.sha }}
        **Deployed by:** ${{ github.actor }}
        **Workflow Run:** ${{ github.run_id }}
        
        ## ğŸ—ï¸ Infrastructure Deployed
        - Resource Group: \`rg-live-demo\`
        - Storage Account: \`livesa002\` 
        - Key Vault: \`live-kv-testing\`
        - Location: East US
        
        ## ğŸš€ Deployment Pipeline
        1. âœ… Feature branch development
        2. âœ… LAB environment testing
        3. âœ… Auto-promotion to staging
        4. âœ… NLV environment validation
        5. âœ… Auto-promotion to main
        6. âœ… Production deployment with approvals
        
        ## ğŸ”’ Security & Compliance
        - [x] Multi-stage approval process
        - [x] Environment-specific configurations
        - [x] Infrastructure as Code
        - [x] Full audit trail
        - [x] Automated testing
        
        **Status: PRODUCTION LIVE** ğŸŸ¢
        EOF
        
        cat deployment-report.md
    
    - name: Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: production-deployment-report-${{ github.run_id }}
        path: deployment-report.md
        retention-days: 30

  # ğŸ’¥ MANUAL STEP: Destroy infrastructure (only manual trigger with extra protection)
  terraform-destroy:
    name: "ğŸ’¥ Terraform Destroy (PRODUCTION) - MANUAL ONLY âš ï¸"
    if: github.event_name == 'workflow_dispatch'
    uses: ./.github/templates/terraform-destroy.yml
    with:
      environment: lv
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}