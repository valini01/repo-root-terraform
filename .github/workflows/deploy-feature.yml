name: "üß™ Deploy Feature Branch (LAB Environment)"

on:
  push:
    branches:
      - 'feature/**'  # Triggers on any feature branch
  pull_request:
    branches:
      - 'feature/**'

env:
  ENVIRONMENT: lab

jobs:
  # üö¶ STEP 1: Validate the Terraform code
  terraform-validate:
    name: "Terraform Validate (LAB)"
    uses: ./.github/templates/terraform-validate.yml
    with:
      environment: ${{ env.ENVIRONMENT }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # üìã STEP 2: Plan the deployment
  terraform-plan:
    name: "üìã Terraform Plan (LAB)"
    needs: terraform-validate
    uses: ./.github/templates/terraform-plan.yml
    with:
      environment: ${{ env.ENVIRONMENT }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # üöÄ STEP 3: Apply the deployment (only on push, not PR)
  terraform-apply:
    name: "üöÄ Terraform Apply (LAB)"
    needs: terraform-plan
    if: github.event_name == 'push' && github.ref_type == 'branch' && contains(github.ref, 'feature/')
    uses: ./.github/templates/terraform-apply.yml
    with:
      environment: ${{ env.ENVIRONMENT }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # ü§ñ STEP 4: Auto-create PR to staging (magic happens here!)
  create-staging-pr:
    name: "Auto-Create PR to Staging"
    needs: terraform-apply
    if: success() && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}
        fetch-depth: 0
    
    - name: Check and Create Staging Branch
      run: |
        TARGET_BRANCH="staging"
        TARGET_BRANCH=${TARGET_BRANCH:-staging}
        echo "Using target branch: $TARGET_BRANCH"
        
        # Set environment variable for consistent usage
        export TARGET_BRANCH="$TARGET_BRANCH"
        echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_ENV
        
        # Check if staging branch exists
        if git ls-remote --heads origin $TARGET_BRANCH | grep -q $TARGET_BRANCH; then
          echo "Branch '$TARGET_BRANCH' already exists"
        else
          echo "Creating branch '$TARGET_BRANCH' from main"
          git checkout main
          git checkout -b $TARGET_BRANCH
          git push origin $TARGET_BRANCH
          echo "Branch '$TARGET_BRANCH' created successfully"
        fi
    
    - name: Create Pull Request to Staging
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GH_PAT }}
        base: ${{ env.TARGET_BRANCH }}  # üéØ Target: staging branch (dynamic)
        head: ${{ github.ref_name }}  # üåø Source: current feature branch
        title: "Auto PR: Deploy ${{ github.ref_name }} to ${{ env.TARGET_BRANCH }}"
        body: |
          ## üöÄ Automatic Deployment PR
          
          **Source Branch:** `${{ github.ref_name }}`
          **Target Branch:** `${{ env.TARGET_BRANCH }}`
          **Target Environment:** Non-Live (NLV)
          
          ### ‚úÖ LAB Deployment Status
          - [x] Terraform validate passed ‚úÖ
          - [x] Terraform plan successful ‚úÖ
          - [x] LAB deployment completed ‚úÖ
          - [x] All tests passed in LAB environment ‚úÖ
          
          ### üìã Next Steps
          - [ ] Team lead review and approval ‚è≥
          - [ ] Merge to ${{ env.TARGET_BRANCH }} branch ‚è≥
          - [ ] NLV deployment with approval gate ‚è≥
          
          ### üîç Changes Summary
          - Infrastructure changes deployed to LAB
          - Ready for staging environment deployment
          - All validations passed
          
          ### üèóÔ∏è Infrastructure Resources
          - Resource Group: `rg-lab-demo` ‚Üí `rg-non-live-demo`
          - Storage Account: `labsa001` ‚Üí `nonlivesa003`
          - Key Vault: `lab-kv-testing` ‚Üí `nonlive-kv-testing`
          
          **ü§ñ Auto-generated PR from successful LAB deployment**
          
          **Commit SHA:** `${{ github.sha }}`
          **Triggered by:** @${{ github.actor }}
        draft: false

  # üóëÔ∏è MANUAL STEP: Destroy infrastructure (only manual trigger)
  terraform-destroy:
    name: "Terraform Destroy (LAB) - Manual Only"
    if: github.event_name == 'workflow_dispatch'  # Only manual trigger
    uses: ./.github/templates/terraform-destroy.yml
    with:
      environment: ${{ env.ENVIRONMENT }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}