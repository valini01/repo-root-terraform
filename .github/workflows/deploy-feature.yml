name: "ğŸ§ª Deploy Feature Branch (LAB Environment)"

on:
  push:
    branches:
      - 'feature/**'  # Only feature branches
  pull_request:
    branches:
      - 'feature/**'

jobs:
  # ğŸš¦ STEP 1: Validate the Terraform code
  terraform-validate:
    name: "âœ… Terraform Validate (LAB)"
    uses: ./.github/templates/terraform-validate.yml@main
    with:
      environment: lab
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸ“‹ STEP 2: Plan the deployment
  terraform-plan:
    name: "ğŸ“‹ Terraform Plan (LAB)"
    needs: terraform-validate
    uses: ./.github/templates/terraform-plan.yml@main
    with:
      environment: lab
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸš€ STEP 3: Apply the deployment (only on push, not PR)
  terraform-apply:
    name: "ğŸš€ Terraform Apply (LAB)"
    needs: terraform-plan
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/feature/')
    uses: ./.github/templates/terraform-apply.yml@main
    with:
      environment: lab
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  # ğŸ¤– STEP 4: Auto-create PR to staging
  create-staging-pr:
    name: "ğŸ¤– Auto-Create PR to Staging"
    needs: terraform-apply
    if: success() && github.event_name == 'push' && startsWith(github.ref, 'refs/heads/feature/')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}
        fetch-depth: 0
    
    - name: Check and Create Staging Branch
      run: |
        TARGET_BRANCH="staging"
        TARGET_BRANCH=${TARGET_BRANCH:-staging}
        echo "Using target branch: $TARGET_BRANCH"
        
        # Set environment variable for consistent usage
        export TARGET_BRANCH="$TARGET_BRANCH"
        echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_ENV
        
        # Check if staging branch exists
        if git ls-remote --heads origin $TARGET_BRANCH | grep -q $TARGET_BRANCH; then
          echo "Branch '$TARGET_BRANCH' already exists"
        else
          echo "Creating branch '$TARGET_BRANCH' from main"
          git checkout main
          git checkout -b $TARGET_BRANCH
          git push origin $TARGET_BRANCH
          echo "Branch '$TARGET_BRANCH' created successfully"
        fi
    
    - name: Create Pull Request to Staging
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GH_PAT }}
        base: ${{ env.TARGET_BRANCH }}  # ğŸ¯ Target: staging branch (dynamic)
        head: ${{ github.ref_name }}  # ğŸŒ¿ Source: current feature branch
        title: "Auto PR: Deploy ${{ github.ref_name }} to ${{ env.TARGET_BRANCH }}"
        body: |
          ## ğŸš€ Automatic Deployment PR
          
          **Source Branch:** `${{ github.ref_name }}`
          **Target Branch:** `${{ env.TARGET_BRANCH }}`
          **Target Environment:** Non-Live (NLV)
          
          ### âœ… LAB Deployment Status
          - [x] Terraform validate passed âœ…
          - [x] Terraform plan successful âœ…
          - [x] LAB deployment completed âœ…
          - [x] All tests passed in LAB environment âœ…
          
          ### ğŸ“‹ Next Steps
          - [ ] Team lead review and approval â³
          - [ ] Merge to ${{ env.TARGET_BRANCH }} branch â³
          - [ ] NLV deployment with approval gate â³
          
          ### ğŸ” Changes Summary
          - Infrastructure changes deployed to LAB
          - Ready for staging environment deployment
          - All validations passed
          
          ### ğŸ—ï¸ Infrastructure Resources
          - Resource Group: `rg-lab-demo` â†’ `rg-non-live-demo`
          - Storage Account: `labsa001` â†’ `nonlivesa003`
          - Key Vault: `lab-kv-testing` â†’ `nonlive-kv-testing`
          
          **ğŸ¤– Auto-generated PR from successful LAB deployment**
          
          **Commit SHA:** `${{ github.sha }}`
          **Triggered by:** @${{ github.actor }}
        draft: false

  # ğŸ—‘ï¸ MANUAL STEP: Destroy infrastructure (only manual trigger)
  terraform-destroy:
    name: "ğŸ’¥ Terraform Destroy (LAB) - Manual Only"
    if: github.event_name == 'workflow_dispatch'
    uses: ./.github/templates/terraform-destroy.yml@main
    with:
      environment: lab
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}