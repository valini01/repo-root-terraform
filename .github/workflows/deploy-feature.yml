name: "ðŸ§ª Deploy LAB for Feature Branch"

on:
  push:
    branches:
      - "features/shubhi/deleting"

jobs:
  validate:
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.action == 'deploy') }}
    uses: ./.github/workflows/terraform-validate.yml
    with:
      environment: lab
    secrets: inherit

  plan:
    needs: validate
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: lab
    secrets: inherit

  apply:
    needs: plan
    uses: ./.github/workflows/terraform-apply.yml
    with:
      environment: lab
    secrets: inherit

  destroy:
    needs: apply
    uses: ./.github/workflows/terraform-destroy.yml
    with:
      environment: lab
    secrets: inherit

  create-staging-pr:
    name: "Auto PR â†’ Staging"
    needs: apply
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate GitHub App
        env:
          GH_APP_ID: ${{ secrets.APP_ID }}
          GH_APP_INSTALLATION_ID: ${{ secrets.INSTALLATION_ID }}
          GH_APP_PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          # Generate JWT to authenticate as the GitHub App
          header='{"alg":"RS256","typ":"JWT"}'
          iat=$(($(date +%s) - 60))
          exp=$(($(date +%s) + 540))
          payload=$(jq -nc --arg iat "$iat" --arg exp "$exp" --arg iss "$GH_APP_ID" '{"iat":($iat|tonumber),"exp":($exp|tonumber),"iss":($iss|tonumber)}')
          JWT=$(echo -n "${header}" | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')'.'$(echo -n "${payload}" | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')
          SIGNATURE=$(echo -n "${JWT}" | openssl dgst -binary -sha256 -sign <(echo "$GH_APP_PRIVATE_KEY") | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')
          JWT="${JWT}.${SIGNATURE}"

          # Exchange JWT for installation access token
          ACCESS_TOKEN=$(curl -s -X POST \
            -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/app/installations/$GH_APP_INSTALLATION_ID/access_tokens | jq -r .token)

          echo "GH_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
          echo "âœ… Authenticated with GitHub App successfully"

      - name: Check and Create Staging Branch
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}
        run: |
          echo "Checking if staging branch exists..."
          git fetch origin
          
          if git ls-remote --heads origin staging | grep -q staging; then
            echo "âœ… Staging branch already exists"
          else
            echo "âš ï¸ Staging branch does not exist. Creating from main..."
            git fetch origin main:main
            git checkout -b staging main
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} staging
            echo "âœ… Staging branch created successfully"
          fi

      - name: Create PR to Staging (with approval required)
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}
        run: |
          echo "Creating PR from ${{ github.ref_name }} to staging..."
          
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base staging --head ${{ github.ref_name }} --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "âœ… PR #$EXISTING_PR already exists"
            gh pr view $EXISTING_PR --web || true
          else
            echo "Creating new PR..."
            
            gh pr create \
              --base staging \
              --head ${{ github.ref_name }} \
              --title "ðŸš€ Promote ${{ github.ref_name }} â†’ Staging" \
              --body "## LAB Deployment Completed Successfully!
          
          **Source Branch:** \`${{ github.ref_name }}\`  
          **Target Branch:** \`staging\`  
          **Workflow Run:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### âœ… Deployment Summary
          - Quality Scans: Passed
          - Terraform Validate: Passed
          - Terraform Plan: Generated
          - Terraform Apply: Completed (LAB)
          
          **Environment:** LAB  
          **Commit:** \`${{ github.sha }}\`
          
          ---
          
          ### âš ï¸ Required Actions:
          1. **Review the changes** in this PR  
          2. **Approve** if everything looks good  
          3. **Merge** to deploy to Staging environment  
          
          > **Note:** This PR requires approval before merging. Branch protection rules enforce code review." \
              --reviewer shubhi0302
            
            echo "âœ… PR created successfully"
          fi