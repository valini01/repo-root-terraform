name: "ðŸ§ª Deploy LAB for Feature Branch"

on:
  push:
    branches:
      - "features/shubhi/testing"


jobs:
  validate:
    uses: ./.github/workflows/terraform-validate.yml
    with:
      environment: lab
    secrets:
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

  plan:
    needs: validate
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: lab
    secrets:
      GH_PAT: ${{ secrets.GH_PAT }}
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}
      STATE_RESOURCE_GROUP_NAME: ${{ secrets.STATE_RESOURCE_GROUP_NAME }}
      STATE_STORAGE_ACCOUNT_NAME: ${{ secrets.STATE_STORAGE_ACCOUNT_NAME }}
      STATE_CONTAINER_NAME: ${{ secrets.STATE_CONTAINER_NAME }}

  apply:
    needs: plan
    uses: ./.github/workflows/terraform-apply.yml
    with:
      environment: lab
    secrets:
      GH_PAT: ${{ secrets.GH_PAT }}
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}
      STATE_RESOURCE_GROUP_NAME: ${{ secrets.STATE_RESOURCE_GROUP_NAME }}
      STATE_STORAGE_ACCOUNT_NAME: ${{ secrets.STATE_STORAGE_ACCOUNT_NAME }}
      STATE_CONTAINER_NAME: ${{ secrets.STATE_CONTAINER_NAME }}

  destroy:
    needs: apply
    uses: ./.github/workflows/terraform-destroy.yml
    with:
      environment: lab
    secrets:
      GH_PAT: ${{ secrets.GH_PAT }}
      AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}
      STATE_RESOURCE_GROUP_NAME: ${{ secrets.STATE_RESOURCE_GROUP_NAME }}
      STATE_STORAGE_ACCOUNT_NAME: ${{ secrets.STATE_STORAGE_ACCOUNT_NAME }}
      STATE_CONTAINER_NAME: ${{ secrets.STATE_CONTAINER_NAME }}

  create-staging-pr:
    name: "Auto PR â†’ Staging"
    needs: apply
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Check and Create Staging Branch
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Checking if staging branch exists..."
          
          # Fetch all branches
          git fetch origin
          
          # Check if staging branch exists remotely
          if git ls-remote --heads origin staging | grep -q staging; then
            echo "âœ… Staging branch already exists"
          else
            echo "âš ï¸ Staging branch does not exist. Creating from main..."
            
            # Create staging branch from main
            git fetch origin main:main
            git checkout -b staging main
            git push origin staging
            
            echo "âœ… Staging branch created successfully"
          fi

      - name: Create PR to Staging (with approval required)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Creating PR from ${{ github.ref_name }} to staging..."
          
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base staging --head ${{ github.ref_name }} --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "âœ… PR #$EXISTING_PR already exists"
            gh pr view $EXISTING_PR --web || true
          else
            echo "Creating new PR..."
            
            # Create PR with reviewers
            gh pr create \
              --base staging \
              --head ${{ github.ref_name }} \
              --title "ðŸš€ Promote ${{ github.ref_name }} â†’ Staging" \
              --body "## LAB Deployment Completed Successfully!
          
          **Source Branch:** \`${{ github.ref_name }}\`  
          **Target Branch:** \`staging\`  
          **Workflow Run:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### âœ… Deployment Summary
          - Quality Scans: Passed
          - Terraform Validate: Passed
          - Terraform Plan: Generated
          - Terraform Apply: Completed (LAB)
          
          **Environment:** LAB  
          **Commit:** \`${{ github.sha }}\`
          
          ---
          
          ### âš ï¸ Required Actions:
          1. **Review the changes** in this PR
          2. **Approve** if everything looks good
          3. **Merge** to deploy to Staging environment
          
          > **Note:** This PR requires approval before merging. Branch protection rules enforce code review." \
              --reviewer shubhi0302
            
            echo "âœ… PR created successfully"
          fi
